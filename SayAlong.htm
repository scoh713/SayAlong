<!DOCTYPE html>
<html>
<body>
<div align='center'>
	Video <input type="file" id="fileVideo" accept=".mp4" />
	Subtitle <input type="file" id="fileSub" accept=".srt" />
</div>
<table>
	<tr>
		<td colspan=3> <video id="myVideo" width="100%" controls autobuffer/> </td>
	</tr>
	<tr>
		<td width="50%"> <div id="sub_pos" style="height:20px"/> </td>
		<td> Speed 0.5<input type="range" id="playSpeed" min="0.5" max="1" step="0.25" value="1">1 </td>
		<td><input type="button" id="refreshSub" value="Refresh" style="overflow:auto"></td>
	</tr>
	<tr>
		<td colspan=3> <div id="mySubtitle" style="height:200px; table-layout:fixed; overflow-y:scroll; border:thin double #000"/> </td>
	</tr>
</table>
</body>

<script type ="text/javascript">
var	fileVideo, fileSub, refreshSub, playSpeed, leftButton, rightButton;
var	video, subtitle;
var	cur_pos, last_pos;
var	pos_end;
var	play_part = false;	// if true, play a part of video
var	parts = new Array();

window.onload = function () {
	fileVideo = document.getElementById('fileVideo');
	fileVideo.addEventListener('change', loadVideo, false);
	fileSub = document.getElementById("fileSub");
	fileSub.addEventListener('change', loadSub, false);
	refreshSub = document.getElementById("refreshSub");
	refreshSub.addEventListener('click', reloadSub, false);
	playSpeed = document.getElementById("playSpeed");
	playSpeed.addEventListener('change', changeSpeed, false);
	video = document.getElementById("myVideo");
	video.addEventListener('timeupdate', checkTime, false);
	video.addEventListener('mousewheel', scrollVideo, false);
	video.addEventListener('click', checkPart, false);
	subtitle = document.getElementById('mySubtitle');
	document.addEventListener('keydown', hotKey, false);
	cur_pos = 0;
}

function	Position (left, right) { this.start = left; this.end = right; }

function	doPlayPart (pos) {	// start play at pos_start
	if (cur_pos != pos) {
		document.getElementById('sub_pos').innerHTML = "Position: " + pos + " / " + last_pos;
		cur_pos = pos;
	} 
	video.currentTime = parts[pos].start/1000.0;
	pos_end = parts[cur_pos].end/1000.0;
	video.play();
	play_part = true;
	video.addEventListener('timeupdate', checkTime, false);
}

function	checkTime () {	// end play at pos_end
	//document.getElementById('label').innerHTML = parseInt(video.currentTime);
	if (video.currentTime >= pos_end && play_part) {
		video.pause();
		play_part = false;
	}
}

function	scrollVideo (e) {
	if (e.wheelDelta > 0)
		video.currentTime += 1.0;
	else
		video.currentTime -= 1.0;
}

function	checkPart () {	// check the index of subtitle
	time_msec = Math.floor(video.currentTime * 1000);
	document.getElementById('sub_pos').innerHTML = " ";

	// binary search for current position of subtitle
	left = 0; right = parts.length-1;
	mid = Math.floor((left + right) / 2);
	while (left < right) {
		if (time_msec < parts[mid].start) right = mid-1;
		else if (parts[mid+1].start <= time_msec) left = mid+1;
		else break;
		mid = Math.floor((left + right) / 2);
	}
	cur_pos = mid;
	document.getElementById('sub_pos').innerHTML = "Position: " + cur_pos + " / " + last_pos;
}

function	hotKey (e) {
	var	speed = playSpeed.valueAsNumber;

	if (e.keyCode == 90)		// previous: '<-' 37, 'z' 90
		doPlayPart(cur_pos-1);
	else if (e.keyCode == 88)		// current: 'PgDn' 40, 'x' 88
		doPlayPart(cur_pos);
	else if (e.keyCode == 67)		// next: '->' 39, 'c' 67
		doPlayPart(cur_pos+1);
	else if (e.keyCode == 83)		// slower: 's'
		{ if (speed >= 0.75) speed -= 0.25; }
	else if (e.keyCode == 70)		// faster: 'f'
		{ if (speed <= 0.75) speed += 0.25; }

	playSpeed.value = speed;
	video.playbackRate = speed;

// Ref: https://www.python2.net/questions-994925.htm
}

function	loadVideo (e) { video.src = fileVideo.files[0].name; }

function	loadSub (e) {
	var	reader = new FileReader();
	var	tmp = fileSub.files[0].name.split('.');
	var	ext = tmp[tmp.length-1].toLowerCase();

	if (ext == "json") reader.onload = function(e) { getJsonSub(reader.result); }
	else if (ext == "srt") reader.onload = function(e) { getSrtSub(reader.result); }
	reader.readAsText(fileSub.files[0]);
//alert("loadSub: "+document.location.pathname);

// Ref: https://pks2974.medium.com/file-api-%EC%A0%95%EB%A6%AC%ED%95%98%EA%B8%B0-729fa6a3a0ba
// Ref: https://pythonq.com/so/javascript/1911538
}

function	reloadSub (e) { loadSub(e); }

function	changeSpeed (e) {
	var	speed = playSpeed.valueAsNumber;
	video.playbackRate = speed;
}

function	getJsonSub (text) {
	var	json = JSON.parse(text);
	var	str = "";
	for (var pos = 0; pos < json.list.length; pos++) {
		str = str + pos+"\t<a onclick=\"doPlayPart("+pos+");\">"+json.list[pos].text+"</a><br>";
		parts[pos] = new Position(json.list[pos].start, json.list[pos].end);
	}
	subtitle.innerHTML = str;
}

function	getSrtSub (text) {
//alert("getSrtSub");

	function	strip (s) { return s.replace(/^\s+|\s+$/g,""); }
	function	mSec (str) {
		var str1 = strip(str).split(':');
		var str2 = str1[2].split(',');
		return ((str1[0]*60+str1[1])*60+parseInt(str2[0]))*1000+parseInt(str2[1]);
	}
	var	srt = strip(text.replace(/\r\n|\r|\n/g, '\n')).split('\n\n');
	var	str = "";

	for (s in srt) {
		st = srt[s].split('\n');
		if (st.length >=2) {
			last_pos = n = st[0];	// num
			t = st[2];	// text
			var	tmp1 = st[1].split(' --> ');
			parts[n] = new Position(mSec(tmp1[0]), mSec(tmp1[1]));
			if (st.length > 2)
				for (j = 3; j < st.length; j++) t += ' '+st[j];
			str = str + n + " :" + "\t<a onclick=\"doPlayPart("+n+");\">"+t+"</a><br>";
		}
	}
	subtitle.innerHTML = str;
}

</script>
</html>
